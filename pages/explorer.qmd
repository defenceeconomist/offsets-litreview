---
title: "CMO Explorer"
format: html
execute:
  echo: false
---

```{=html}
<style>
  .cmo-controls {
    display: grid;
    grid-template-columns: repeat(4, minmax(180px, 1fr));
    gap: 12px;
    margin: 12px 0 20px 0;
  }
  .cmo-controls label {
    font-weight: 600;
    display: block;
    margin-bottom: 6px;
  }
  .cmo-controls select,
  .cmo-controls input {
    width: 100%;
  }
  @media (max-width: 900px) {
    .cmo-controls {
      grid-template-columns: 1fr;
    }
  }
  table.dataTable tbody td {
    vertical-align: top;
  }
</style>

<div class="cmo-controls">
  <div>
    <label for="searchText">Search text</label>
    <input id="searchText" type="text" placeholder="context / mechanism / outcome / evidence">
  </div>
  <div>
    <label for="matchMode">Tag match mode</label>
    <select id="matchMode">
      <option value="any">Match any</option>
      <option value="all">Match all</option>
    </select>
  </div>
  <div>
    <label for="tagContext">Context tags</label>
    <select id="tagContext" multiple size="6"></select>
  </div>
  <div>
    <label for="tagMechanism">Mechanism tags</label>
    <select id="tagMechanism" multiple size="6"></select>
  </div>
  <div>
    <label for="tagOutcome">Outcome tags</label>
    <select id="tagOutcome" multiple size="6"></select>
  </div>
  <div>
    <label for="rqFilter">Research questions</label>
    <select id="rqFilter" multiple size="6"></select>
  </div>
  <div>
    <label for="countryFilter">Country</label>
    <select id="countryFilter" multiple size="6"></select>
  </div>
  <div>
    <label for="evidenceFilter">Evidence type</label>
    <select id="evidenceFilter" multiple size="6"></select>
  </div>
</div>

<table id="cmoTable" class="display" style="width:100%"></table>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt@1.13.8/css/jquery.dataTables.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
  const csvPath = "data/cmo_statements.csv";

  const tagCols = {
    context_tags: "tagContext",
    mechanism_tags: "tagMechanism",
    outcome_tags: "tagOutcome",
    mechanism_theme_labels: "tagTheme"
  };

  const splitTags = (val) => {
    if (!val) return [];
    return val.split(/[,;\s]+/).filter(Boolean);
  };

  const uniqueSorted = (arr) => Array.from(new Set(arr)).sort();

  const getSelected = (id) => {
    const el = document.getElementById(id);
    if (!el) return [];
    return Array.from(el.selectedOptions).map(o => o.value);
  };

  const fillSelect = (id, values) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = "";
    values.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      el.appendChild(opt);
    });
  };

  const matchesTags = (rowVal, selected, mode) => {
    if (!selected.length) return true;
    const tags = splitTags(rowVal);
    if (!tags.length) return false;
    if (mode === "all") return selected.every(t => tags.includes(t));
    return selected.some(t => tags.includes(t));
  };

  let table;
  let dataRows = [];

  Papa.parse(csvPath, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      dataRows = results.data || [];
      const cols = results.meta.fields || [];
      const preferred = ["context", "mechanism", "outcome"];
      const orderedCols = [
        ...preferred.filter(c => cols.includes(c)),
        ...cols.filter(c => !preferred.includes(c))
      ];

      const tableCols = orderedCols.map(c => ({ title: c, data: c }));
      table = $("#cmoTable").DataTable({
        data: dataRows,
        columns: tableCols,
        pageLength: 25,
        scrollX: true,
        order: []
      });

      // Populate tag selects
      Object.entries(tagCols).forEach(([col, selectId]) => {
        const allTags = uniqueSorted(
          dataRows.flatMap(r => splitTags(r[col] || ""))
        );
        fillSelect(selectId, allTags);
      });

      // Populate country and evidence filters
      fillSelect("rqFilter", uniqueSorted(dataRows.flatMap(r => splitTags(r.research_questions_mapped || ""))));
      fillSelect("countryFilter", uniqueSorted(dataRows.map(r => r.country).filter(Boolean)));
      fillSelect("evidenceFilter", uniqueSorted(dataRows.map(r => r.evidence_type).filter(Boolean)));

      const applyFilters = () => {
        const mode = document.getElementById("matchMode").value;
        const selContext = getSelected("tagContext");
        const selMech = getSelected("tagMechanism");
        const selOutcome = getSelected("tagOutcome");
        const selTheme = getSelected("tagTheme");
        const selRQ = getSelected("rqFilter");
        const selCountry = getSelected("countryFilter");
        const selEvidence = getSelected("evidenceFilter");
        const text = document.getElementById("searchText").value.toLowerCase();

        const filtered = dataRows.filter(r => {
          if (text) {
            const hay = [
              r.context, r.mechanism, r.outcome,
              r.supporting_evidence, r.supporting_evidence_paraphrase
            ].join(" ").toLowerCase();
            if (!hay.includes(text)) return false;
          }

          if (!matchesTags(r.context_tags, selContext, mode)) return false;
          if (!matchesTags(r.mechanism_tags, selMech, mode)) return false;
          if (!matchesTags(r.outcome_tags, selOutcome, mode)) return false;
          if (!matchesTags(r.mechanism_theme_labels, selTheme, mode)) return false;
          if (!matchesTags(r.research_questions_mapped, selRQ, mode)) return false;

          if (selCountry.length && !selCountry.includes(r.country || "")) return false;
          if (selEvidence.length && !selEvidence.includes(r.evidence_type || "")) return false;

          return true;
        });

        table.clear();
        table.rows.add(filtered);
        table.draw();
      };

      document.querySelectorAll(
        "#searchText, #matchMode, #tagContext, #tagMechanism, #tagOutcome, #tagTheme, #rqFilter, #countryFilter, #evidenceFilter"
      ).forEach(el => {
        el.addEventListener("input", applyFilters);
        el.addEventListener("change", applyFilters);
      });
    }
  });
</script>
```
